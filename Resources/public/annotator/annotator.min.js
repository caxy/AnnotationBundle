/*
** Annotator v1.2.7
** https://github.com/okfn/annotator/
**
** Copyright 2012 Aron Carroll, Rufus Pollock, and Nick Stenning.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2013-06-27 21:49:30Z
*/((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=[].slice,z={}.hasOwnProperty,A=function(a,b){function d(){this.constructor=a}for(var c in b)z.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},B=function(a,b){return function(){return a.apply(b,arguments)}};n=function(b){var c;return c=this.map(function(){var c,d,e,f;e="",c=this;while((c!=null?c.nodeType:void 0)===Node.ELEMENT_NODE&&c!==b)f=c.tagName.replace(":","\\:"),d=a(c.parentNode).children(f).index(c)+1,d="["+d+"]",e="/"+c.tagName.toLowerCase()+d+e,c=c.parentNode;return e}),c.get()},o=function(a){var b,c,d,e;return b=function(a){var b,c;return b=k(a),c=l(a),""+b+"["+c+"]"},e=a,c=function(a){var c;c="";while(a!==e){if(a==null)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+e);c=b(a)+"/"+c,a=a.parentNode}return c="/"+c,c=c.replace(/\/$/,""),c},d=this.map(function(){var a;return a=c(this),a}),d.get()},g=function(a,b,c){var d,e,f,g,h,i;if(!a.hasChildNodes())throw new Error("XPath error: node has no children!");e=a.childNodes,f=0;for(h=0,i=e.length;h<i;h++){d=e[h],g=k(d);if(g===b){f+=1;if(f===c)return d}}throw new Error("XPath error: wanted child not found.")},k=function(a){var b;b=a.nodeName.toLowerCase();switch(b){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}},l=function(a){var b,c;b=0,c=a;while(c)c.nodeName===a.nodeName&&b++,c=c.previousSibling;return b},m=null,typeof Gettext!="undefined"&&Gettext!==null?(q=new Gettext({domain:"annotator"}),m=function(a){return q.gettext(a)}):m=function(a){return a},x=function(a){return m(a)},(typeof jQuery!="undefined"&&jQuery!==null?(v=jQuery.fn)!=null?v.jquery:void 0:void 0)||console.error(x("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(x("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),a=jQuery,f={},f.flatten=function(b){var c;return c=function(b){var d,e,f,g;e=[];for(f=0,g=b.length;f<g;f++)d=b[f],e=e.concat(d&&a.isArray(d)?c(d):d);return e},c(b)},f.getTextNodes=function(a){var b;return b=function(a){var c;if(a&&a.nodeType!==Node.TEXT_NODE){c=[];if(a.nodeType!==Node.COMMENT_NODE){a=a.lastChild;while(a)c.push(b(a)),a=a.previousSibling}return c.reverse()}return a},a.map(function(){return f.flatten(b(this))})},f.xpathFromNode=function(a,b){var c,d;try{d=n.call(a,b)}catch(e){c=e,console.log("jQuery-based XPath construction failed! Falling back to manual."),d=o.call(a,b)}return d},f.nodeFromXPath=function(a,b){var c,d,e,f,h,i,j,k;h=a.substring(1).split("/"),e=b;for(i=0,j=h.length;i<j;i++)f=h[i],k=f.split("["),d=k[0],c=k[1],c=c!=null?parseInt((c!=null?c.split("]"):void 0)[0]):1,e=g(e,d.toLowerCase(),c);return e},f.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},f.uuid=function(){var a;return a=0,function(){return a++}}(),f.getGlobal=function(){return function(){return this}()},f.maxZIndex=function(b){var c,d;return c=function(){var c,e,f;f=[];for(c=0,e=b.length;c<e;c++)d=b[c],a(d).css("position")==="static"?f.push(-1):f.push(parseInt(a(d).css("z-index"),10)||-1);return f}(),Math.max.apply(Math,c)},f.mousePosition=function(b,c){var d;return d=a(c).position(),{top:b.pageY-d.top,left:b.pageX-d.left}},f.preventEventDefault=function(a){return a!=null?typeof a.preventDefault=="function"?a.preventDefault():void 0:void 0},i=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!="undefined"&&console!==null){console.group==null&&(console.group=function(a){return console.log("GROUP: ",a)}),console.groupCollapsed==null&&(console.groupCollapsed=console.group);for(r=0,t=i.length;r<t;r++)h=i[r],console[h]==null&&(console[h]=function(){return console.log(x("Not implemented:")+(" console."+name))})}else{this.console={};for(s=0,u=i.length;s<u;s++)h=i[s],this.console[h]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?y.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?y.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}c=function(){function b(b,c){this.options=a.extend(!0,{},this.options,c),this.element=a(b),this.on=this.subscribe,this.addEvents()}return b.prototype.events={},b.prototype.options={},b.prototype.element=null,b.prototype.addEvents=function(){var a,b,c,d,e,f,g,h;f=this.events,h=[];for(c in f)b=f[c],g=c.split(" "),d=2<=g.length?y.call(g,0,e=g.length-1):(e=0,[]),a=g[e++],h.push(this.addEvent(d.join(" "),a,b));return h},b.prototype.addEvent=function(b,c,d){var e,f,g=this;return e=function(){return g[d].apply(g,arguments)},f=typeof b=="string"&&b.replace(/\s+/g,"")==="",f&&(b=this.element),typeof b=="string"?this.element.delegate(b,c,e):this.isCustomEvent(c)?this.subscribe(c,e):a(b).bind(c,e),this},b.prototype.isCustomEvent=function(c){return c=c.split(".")[0],a.inArray(c,b.natives)===-1},b.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},b.prototype.subscribe=function(b,c){var d;return d=function(){return c.apply(this,[].slice.call(arguments,1))},d.guid=c.guid=a.guid+=1,this.element.bind(b,d),this},b.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},b}(),c.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b){if(!z.call(b,a))continue;c=b[a],d.push(a)}return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),e={},e.sniff=function(a){return a.commonAncestorContainer!=null?new e.BrowserRange(a):typeof a.start=="string"?new e.SerializedRange(a):a.start&&typeof a.start=="object"?new e.NormalizedRange(a):(console.error(x("Could not sniff range type")),!1)},e.nodeFromXPath=function(b,c){var d,e,g,h,i;return c==null&&(c=document),e=function(a,b){var d;b==null&&(b=null);try{return document.evaluate("."+a,c,b,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){return d=e,console.log("XPath evaluation failed."),console.log("Trying fallback..."),f.nodeFromXPath(a,c)}},a.isXMLDoc(document.documentElement)?(d=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement),h=e(b,d),h||(b=function(){var a,c,d,e;d=b.split("/"),e=[];for(a=0,c=d.length;a<c;a++)i=d[a],i&&i.indexOf(":")===-1?e.push(i.replace(/^([a-z]+)/,"xhtml:$1")):e.push(i);return e}().join("/"),g=document.lookupNamespaceURI(null),d=function(a){return a==="xhtml"?g:document.documentElement.getAttribute("xmlns:"+a)},h=e(b,d)),h):e(b)},e.RangeError=function(a){function b(a,c,d){this.type=a,this.message=c,this.parent=d!=null?d:null,b.__super__.constructor.call(this,this.message)}return A(b,a),b}(Error),e.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,d,f,g,h,i,j,k;if(this.tainted)return console.error(x("You may only call normalize() once on a BrowserRange!")),!1;this.tainted=!0,h={},d={},k=["start","end"];for(i=0,j=k.length;i<j;i++){g=k[i],c=this[g+"Container"],f=this[g+"Offset"];if(c.nodeType===Node.ELEMENT_NODE){b=c.childNodes[f],c=b||c.childNodes[f-1],c.nodeType===Node.ELEMENT_NODE&&!c.firstChild&&(b=null,c=c.previousSibling);while(c.nodeType!==Node.TEXT_NODE)c=c.firstChild;f=b?0:c.nodeValue.length}h[g]=c,h[g+"Offset"]=f}d.start=h.startOffset>0?h.start.splitText(h.startOffset):h.start,h.start===h.end?(h.endOffset-h.startOffset<d.start.nodeValue.length&&d.start.splitText(h.endOffset-h.startOffset),d.end=d.start):(h.endOffset<h.end.nodeValue.length&&h.end.splitText(h.endOffset),d.end=h.end),d.commonAncestor=this.commonAncestorContainer;while(d.commonAncestor.nodeType!==Node.ELEMENT_NODE)d.commonAncestor=d.commonAncestor.parentNode;return new e.NormalizedRange(d)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),e.NormalizedRange=function(){function b(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return b.prototype.normalize=function(a){return this},b.prototype.limit=function(b){var c,d,e,f,g,h;c=a.grep(this.textNodes(),function(c){return c.parentNode===b||a.contains(b,c.parentNode)});if(!c.length)return null;this.start=c[0],this.end=c[c.length-1],e=a(this.start).parents(),h=a(this.end).parents();for(f=0,g=h.length;f<g;f++){d=h[f];if(e.index(d)!==-1){this.commonAncestor=d;break}}return this},b.prototype.serialize=function(b,c){var d,g,h;return g=function(d,e){var g,h,i,j,k,l,m,n;c?j=a(d).parents(":not("+c+")").eq(0):j=a(d).parent(),l=f.xpathFromNode(j,b)[0],k=f.getTextNodes(j),h=k.slice(0,k.index(d)),i=0;for(m=0,n=h.length;m<n;m++)g=h[m],i+=g.nodeValue.length;return e?[l,i+d.nodeValue.length]:[l,i]},h=g(this.start),d=g(this.end,!0),new e.SerializedRange({start:h[0],end:d[0],startOffset:h[1],endOffset:d[1]})},b.prototype.text=function(){var a;return function(){var b,c,d,e;d=this.textNodes(),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},b.prototype.textNodes=function(){var b,c,d,e;return d=f.getTextNodes(a(this.commonAncestor)),e=[d.index(this.start),d.index(this.end)],c=e[0],b=e[1],a.makeArray(d.slice(c,+b+1||9e9))},b.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},b}(),e.SerializedRange=function(){function b(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return b.prototype.normalize=function(b){var c,d,g,h,i,j,k,l,m,n,o,p,q;j={},p=["start","end"];for(l=0,n=p.length;l<n;l++){i=p[l];try{h=e.nodeFromXPath(this[i],b)}catch(r){throw d=r,new e.RangeError(i,"Error while finding "+i+" node: "+this[i]+": "+d,d)}if(!h)throw new e.RangeError(i,"Couldn't find "+i+" node: "+this[i]);g=0,q=f.getTextNodes(a(h));for(m=0,o=q.length;m<o;m++){k=q[m];if(g+k.nodeValue.length>=this[i+"Offset"]){j[i+"Container"]=k,j[i+"Offset"]=this[i+"Offset"]-g;break}g+=k.nodeValue.length}if(j[i+"Offset"]==null)throw new e.RangeError(""+i+"offset","Couldn't find offset "+this[i+"Offset"]+" in element "+this[i])}return c=document.compareDocumentPosition==null?function(a,b){return a.contains(b)}:function(a,b){return a.compareDocumentPosition(b)&16},a(j.startContainer).parents().each(function(){if(c(this,j.endContainer))return j.commonAncestorContainer=this,!1}),(new e.BrowserRange(j)).normalize(b)},b.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},b.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},b}(),p=this.Annotator,b=function(b){function c(b,d){this.onDeleteAnnotation=B(this.onDeleteAnnotation,this),this.onEditAnnotation=B(this.onEditAnnotation,this),this.onAdderClick=B(this.onAdderClick,this),this.onAdderMousedown=B(this.onAdderMousedown,this),this.onHighlightMouseover=B(this.onHighlightMouseover,this),this.checkForEndSelection=B(this.checkForEndSelection,this),this.checkForStartSelection=B(this.checkForStartSelection,this),this.clearViewerHideTimer=B(this.clearViewerHideTimer,this),this.startViewerHideTimer=B(this.startViewerHideTimer,this),this.showViewer=B(this.showViewer,this),this.onEditorSubmit=B(this.onEditorSubmit,this),this.onEditorHide=B(this.onEditorHide,this),this.showEditor=B(this.showEditor,this),c.__super__.constructor.apply(this,arguments),this.plugins={};if(!c.supported())return this;this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=a(this.html.adder).appendTo(this.wrapper).hide()}return A(c,b),c.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},c.prototype.html={adder:'<div class="annotator-adder"><button>'+x("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},c.prototype.options={readOnly:!1},c.prototype.plugins={},c.prototype.editor=null,c.prototype.viewer=null,c.prototype.selectedRanges=null,c.prototype.mouseIsDown=!1,c.prototype.ignoreMouseup=!1,c.prototype.viewerHideTimer=null,c.prototype._setupWrapper=function(){return this.wrapper=a(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},c.prototype._setupViewer=function(){var b=this;return this.viewer=new c.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(c,d){return d.text?a(c).html(f.escape(d.text)):a(c).html("<i>"+x("No Comment")+"</i>"),b.publish("annotationViewerTextField",[c,d])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},c.prototype._setupEditor=function(){return this.editor=new c.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:x("Comments")+"…",load:function(b,c){return a(b).find("textarea").val(c.text||"")},submit:function(b,c){return c.text=a(b).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},c.prototype._setupDocumentEvents=function(){return a(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},c.prototype._setupDynamicStyle=function(){var b,c,d,e;return d=a("#annotator-dynamic-style"),d.length||(d=a('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),c="*"+function(){var a,b,c,d;c=["adder","outer","notice","filter"],d=[];for(a=0,b=c.length;a<b;a++)e=c[a],d.push(":not(.annotator-"+e+")");return d}().join(""),b=f.maxZIndex(a(document.body).find(c)),b=Math.max(b,1e3),d.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(b+20)+";","}",".annotator-filter {","  z-index: "+(b+10)+";","}"].join("\n")),this},c.prototype.getSelectedRanges=function(){var b,c,d,g,h,i,j,k,l;j=f.getGlobal().getSelection(),h=[],i=[],j.isCollapsed||(h=function(){var a,f,h;h=[];for(c=a=0,f=j.rangeCount;0<=f?a<f:a>f;c=0<=f?++a:--a)g=j.getRangeAt(c),b=new e.BrowserRange(g),d=b.normalize().limit(this.wrapper[0]),d===null&&i.push(g),h.push(d);return h}.call(this),j.removeAllRanges());for(k=0,l=i.length;k<l;k++)g=i[k],j.addRange(g);return a.grep(h,function(a){return a&&j.addRange(a.toRange()),a})},c.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},c.prototype.setupAnnotation=function(b){var c,d,f,g,h,i,j,k,l,m;h=this.wrapper[0],b.ranges||(b.ranges=this.selectedRanges),f=[],m=b.ranges;for(i=0,k=m.length;i<k;i++){g=m[i];try{f.push(e.sniff(g).normalize(h))}catch(n){c=n;if(!(c instanceof e.RangeError))throw c;this.publish("rangeNormalizeFail",[b,g,c])}}b.quote=[],b.ranges=[],b.highlights=[];for(j=0,l=f.length;j<l;j++)d=f[j],b.quote.push(a.trim(d.text())),b.ranges.push(d.serialize(this.wrapper[0],".annotator-hl")),a.merge(b.highlights,this.highlightRange(d));return b.quote=b.quote.join(" / "),a(b.highlights).data("annotation",b),b},c.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),this.publish("annotationUpdated",[a]),a},c.prototype.deleteAnnotation=function(b){var c,d,e,f,g;if(b.highlights!=null){g=b.highlights;for(e=0,f=g.length;e<f;e++){d=g[e];if(d.parentNode==null)continue;c=d.childNodes[0],a(d).replaceWith(d.childNodes)}}return this.publish("annotationDeleted",[b]),b},c.prototype.loadAnnotations=function(a){var b,c,d=this;return a==null&&(a=[]),c=function(a){var e,f,g,h;a==null&&(a=[]),f=a.splice(0,10);for(g=0,h=f.length;g<h;g++)e=f[g],d.setupAnnotation(e);return a.length>0?setTimeout(function(){return c(a)},10):d.publish("annotationsLoaded",[b])},b=a.slice(),a.length&&c(a),this},c.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(x("Can't dump annotations without Store plugin.")),!1)},c.prototype.highlightRange=function(b,c){var d,e,f,g,h,i,j;c==null&&(c="annotator-hl"),f=/^\s*$/,d=a("<span class='"+c+"'></span>"),i=b.textNodes(),j=[];for(g=0,h=i.length;g<h;g++)e=i[g],f.test(e.nodeValue)||j.push(a(e).wrapAll(d).parent().show()[0]);return j},c.prototype.highlightRanges=function(b,c){var d,e,f,g;c==null&&(c="annotator-hl"),d=[];for(f=0,g=b.length;f<g;f++)e=b[f],a.merge(d,this.highlightRange(e,c));return d},c.prototype.addPlugin=function(a,b){var d,e;return this.plugins[a]?console.error(x("You cannot have more than one instance of any plugin.")):(d=c.Plugin[a],typeof d=="function"?(this.plugins[a]=new d(this.element[0],b),this.plugins[a].annotator=this,typeof (e=this.plugins[a]).pluginInit=="function"&&e.pluginInit()):console.error(x("Could not load ")+a+x(" plugin. Have you included the appropriate <script> tag?"))),this},c.prototype.showEditor=function(a,b){return this.editor.element.css(b),this.editor.load(a),this.publish("annotationEditorShown",[this.editor,a]),this},c.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},c.prototype.onEditorSubmit=function(a){return this.publish("annotationEditorSubmit",[this.editor,a])},c.prototype.showViewer=function(a,b){return this.viewer.element.css(b),this.viewer.load(a),this.publish("annotationViewerShown",[this.viewer,a])},c.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},c.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},c.prototype.checkForStartSelection=function(a){return(!a||!this.isAnnotator(a.target))&&this.startViewerHideTimer(),this.mouseIsDown=!0},c.prototype.checkForEndSelection=function(b){var c,d,e,g,h;this.mouseIsDown=!1;if(this.ignoreMouseup)return;this.selectedRanges=this.getSelectedRanges(),h=this.selectedRanges;for(e=0,g=h.length;e<g;e++){d=h[e],c=d.commonAncestor,a(c).hasClass("annotator-hl")&&(c=a(c).parents("[class!=annotator-hl]")[0]);if(this.isAnnotator(c))return}return b&&this.selectedRanges.length?this.adder.css(f.mousePosition(b,this.wrapper[0])).show():this.adder.hide()},c.prototype.isAnnotator=function(b){return!!a(b).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length},c.prototype.onHighlightMouseover=function(b){var c;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(c=a(b.target).parents(".annotator-hl").andSelf().map(function(){return a(this).data("annotation")}),this.showViewer(a.makeArray(c),f.mousePosition(b,this.wrapper[0])))},c.prototype.onAdderMousedown=function(a){return a!=null&&a.preventDefault(),this.ignoreMouseup=!0},c.prototype.onAdderClick=function(b){var c,d,e,f,g,h=this;return b!=null&&b.preventDefault(),f=this.adder.position(),this.adder.hide(),c=this.setupAnnotation(this.createAnnotation()),a(c.highlights).addClass("annotator-hl-temporary"),g=function(){return e(),a(c.highlights).removeClass("annotator-hl-temporary"),h.publish("annotationCreated",[c])},d=function(){return e(),h.deleteAnnotation(c)},e=function(){return h.unsubscribe("annotationEditorHidden",d),h.unsubscribe("annotationEditorSubmit",g)},this.subscribe("annotationEditorHidden",d),this.subscribe("annotationEditorSubmit",g),this.showEditor(c,f)},c.prototype.onEditAnnotation=function(a){var b,c,d,e=this;return c=this.viewer.element.position(),d=function(){return b(),e.updateAnnotation(a)},b=function(){return e.unsubscribe("annotationEditorHidden",b),e.unsubscribe("annotationEditorSubmit",d)},this.subscribe("annotationEditorHidden",b),this.subscribe("annotationEditorSubmit",d),this.viewer.hide(),this.showEditor(a,c)},c.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},c}(c),b.Plugin=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return A(b,a),b.prototype.pluginInit=function(){},b}(c),j=f.getGlobal(),((w=j.document)!=null?w.evaluate:void 0)==null&&a.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),j.getSelection==null&&a.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),j.JSON==null&&a.getScript("http://assets.annotateit.org/vendor/json2.min.js"),j.Node==null&&(j.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),b.$=a,b.Delegator=c,b.Range=e,b.Util=f,b._t=x,b.supported=function(){return function(){return!!this.getSelection}()},b.noConflict=function(){return f.getGlobal().Annotator=p,this},a.fn.annotator=function(c){var d;return d=Array.prototype.slice.call(arguments,1),this.each(function(){var e;return e=a.data(this,"annotator"),e?c&&e[c].apply(e,d):(e=new b(this,c),a.data(this,"annotator",e))})},this.Annotator=b,b.Widget=function(c){function d(c,e){d.__super__.constructor.apply(this,arguments),this.classes=a.extend({},b.Widget.prototype.classes,this.classes)}return A(d,c),d.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},d.prototype.checkOrientation=function(){var c,d,e,f,g;return this.resetOrientation(),g=a(b.Util.getGlobal()),f=this.element.children(":first"),d=f.offset(),e={top:g.scrollTop(),right:g.width()+g.scrollLeft()},c={top:d.top,right:d.left+f.width()},c.top-e.top<0&&this.invertY(),c.right-e.right>0&&this.invertX(),this},d.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},d.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},d.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},d.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},d.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},d}(c),b.Editor=function(c){function d(b){this.onCancelButtonMouseover=B(this.onCancelButtonMouseover,this),this.processKeypress=B(this.processKeypress,this),this.submit=B(this.submit,this),this.load=B(this.load,this),this.hide=B(this.hide,this),this.show=B(this.show,this),d.__super__.constructor.call(this,a(this.html)[0],b),this.fields=[],this.annotation={}}return A(d,c),d.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},d.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},d.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+x("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+x("Save")+"</a>\n    </div>\n  </form>\n</div>",d.prototype.options={},d.prototype.show=function(a){return b.Util.preventEventDefault(a),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},d.prototype.hide=function(a){return b.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},d.prototype.load=function(a){var b,c,d,e;this.annotation=a,this.publish("load",[this.annotation]),e=this.fields;for(c=0,d=e.length;c<d;c++)b=e[c],b.load(b.element,this.annotation);return this.show()},d.prototype.submit=function(a){var c,d,e,f;b.Util.preventEventDefault(a),f=this.fields;for(d=0,e=f.length;d<e;d++)c=f[d],c.submit(c.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},d.prototype.addField=function(c){var d,e,f;e=a.extend({id:"annotator-field-"+b.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},c),f=null,d=a('<li class="annotator-item" />'),e.element=d[0];switch(e.type){case"textarea":f=a("<textarea />");break;case"input":case"checkbox":f=a("<input />");break;case"select":f=a("<select />")}return d.append(f),f.attr({id:e.id,placeholder:e.label}),e.type==="checkbox"&&(f[0].type="checkbox",d.addClass("annotator-checkbox"),d.append(a("<label />",{"for":e.id,html:e.label}))),this.element.find("ul:first").append(d),this.fields.push(e),e.element},d.prototype.checkOrientation=function(){var a,b;return d.__super__.checkOrientation.apply(this,arguments),b=this.element.find("ul"),a=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?a.insertBefore(b):a.is(":first-child")&&a.insertAfter(b),this},d.prototype.processKeypress=function(a){if(a.keyCode===27)return this.hide();if(a.keyCode===13&&!a.shiftKey)return this.submit()},d.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},d.prototype.setupDraggables=function(){var b,c,d,e,f,g,h,i,j,k,l,m=this;return this.element.find(".annotator-resize").remove(),this.element.hasClass(this.classes.invert.y)?d=this.element.find(".annotator-item:last"):d=this.element.find(".annotator-item:first"),d&&a('<span class="annotator-resize"></span>').appendTo(d),f=null,b=this.classes,e=this.element,k=null,j=e.find(".annotator-resize"),c=e.find(".annotator-controls"),l=!1,g=function(b){if(b.target===this)return f={element:this,top:b.pageY,left:b.pageX},k=e.find("textarea:first"),a(window).bind({"mouseup.annotator-editor-resize":i,"mousemove.annotator-editor-resize":h}),b.preventDefault()},i=function(){return f=null,a(window).unbind(".annotator-editor-resize")},h=function(a){var d,g,h,i,m;if(f&&l===!1)return d={top:a.pageY-f.top,left:a.pageX-f.left},f.element===j[0]?(i=k.outerHeight(),m=k.outerWidth(),g=e.hasClass(b.invert.x)?-1:1,h=e.hasClass(b.invert.y)?1:-1,k.height(i+d.top*h),k.width(m+d.left*g),k.outerHeight()!==i&&(f.top=a.pageY),k.outerWidth()!==m&&(f.left=a.pageX)):f.element===c[0]&&(e.css({top:parseInt(e.css("top"),10)+d.top,left:parseInt(e.css("left"),10)+d.left}),f.top=a.pageY,f.left=a.pageX),l=!0,setTimeout(function(){return l=!1},1e3/60)},j.bind("mousedown",g),c.bind("mousedown",g)},d}(b.Widget),b.Viewer=function(c){function e(b){this.onDeleteClick=B(this.onDeleteClick,this),this.onEditClick=B(this.onEditClick,this),this.load=B(this.load,this),this.hide=B(this.hide,this),this.show=B(this.show,this),e.__super__.constructor.call(this,a(this.html.element)[0],b),this.item=a(this.html.item)[0],this.fields=[],this.annotations=[]}return A(e,c),e.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},e.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},e.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},e.prototype.options={readOnly:!1},e.prototype.show=function(a){var c,d=this;return b.Util.preventEventDefault(a),c=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(){return c.removeClass(d.classes.showControls)},500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},e.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},e.prototype.hide=function(a){return b.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},e.prototype.load=function(b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;this.annotations=b||[],n=this.element.find("ul:first").empty(),s=this.annotations;for(o=0,q=s.length;o<q;o++){c=s[o],k=a(this.item).clone().appendTo(n).data("annotation",c),f=k.find(".annotator-controls"),l=f.find(".annotator-link"),h=f.find(".annotator-edit"),g=f.find(".annotator-delete"),m=(new d(c.links||[])).get("alternate",{type:"text/html"}),m.length===0||m[0].href==null?l.remove():l.attr("href",m[0].href),this.options.readOnly?(h.remove(),g.remove()):e={showEdit:function(){return h.removeAttr("disabled")},hideEdit:function(){return h.attr("disabled","disabled")},showDelete:function(){return g.removeAttr("disabled")},hideDelete:function(){return g.attr("disabled","disabled")}},t=this.fields;for(p=0,r=t.length;p<r;p++)j=t[p],i=a(j.element).clone().appendTo(k)[0],j.load(i,c,e)}return this.publish("load",[this.annotations]),this.show()},e.prototype.addField=function(b){var c;return c=a.extend({load:function(){}},b),c.element=a("<div />")[0],this.fields.push(c),c.element,this},e.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},e.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},e.prototype.onButtonClick=function(b,c){var d;return d=a(b.target).parents(".annotator-annotation"),this.publish(c,[d.data("annotation")])},e}(b.Widget),d=function(){function b(a){this.data=a}return b.prototype.get=function(b,c){var d,e,f,g,h,i,j,k,l;c==null&&(c={}),c=a.extend({},c,{rel:b}),f=function(){var a;a=[];for(e in c){if(!z.call(c,e))continue;h=c[e],a.push(e)}return a}(),k=this.data,l=[];for(i=0,j=k.length;i<j;i++){d=k[i],g=f.reduce(function(a,b){return a&&d[b]===c[b]},!0);if(!g)continue;l.push(d)}return l},b}(),b=b||{},b.Notification=function(c){function d(b){this.hide=B(this.hide,this),this.show=B(this.show,this),d.__super__.constructor.call(this,a(this.options.html).appendTo(document.body)[0],b)}return A(d,c),d.prototype.events={click:"hide"},d.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},d.prototype.show=function(c,d){return d==null&&(d=b.Notification.INFO),a(this.element).addClass(this.options.classes.show).addClass(this.options.classes[d]).html(f.escape(c||"")),setTimeout(this.hide,5e3),this},d.prototype.hide=function(){return a(this.element).removeClass(this.options.classes.show),this},d}(c),b.Notification.INFO="show",b.Notification.SUCCESS="success",b.Notification.ERROR="error",a(function(){var a;return a=new b.Notification,b.showNotification=a.show,b.hideNotification=a.hide})})).call(this);